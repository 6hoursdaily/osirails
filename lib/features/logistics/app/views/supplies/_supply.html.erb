<% content_for :header do %>
  <%= stylesheet_link_tag_with_theme_support 'logistics/supply' %>
<% end %>

<% add_contextual_menu_item :possible_actions do %>
  <%= display_supply_category_add_button(@supply_category_type.new) %>
  <%= display_supply_add_button(supply) %>
  
  <%= display_supply_edit_button(supply) unless is_edit_view? or supply.new_record? %>
  <%= display_supply_enable_button(supply) unless supply.new_record? %>
  <%= display_supply_disable_button(supply) unless supply.new_record? %>
  <%= display_supply_delete_button(supply) unless supply.new_record? %>
<% end %>

<% add_contextual_menu_item :useful_links do %>
  <%= display_supply_list_button(@supply_type) %>
<% end %>

<div class="presentation_medium">
  <h2>Caractéristiques</h2>
  <% form_for(supply) do |form| %>
    <%= form.error_messages %>
    
    <fieldset class="presentation_in_columns small">
      <legend>Référencement</legend>
      
      <% unless supply.new_record? %>
        <p>
          <%= form.label :reference %>
          <%= strong supply.reference %>
        </p>
      <% end %>
      
      <div>
        <p>
          <%= form.label :supply_category_id %>
          <% if is_form_view? %>
            <%= form.collection_select :supply_category_id, @supply_categories, :id, :name, { :include_blank => "Veuillez choisir une famille" }, :disabled => supply.has_been_used? %>
            <%= observe_field("#{@supply_type.name.underscore}_supply_category_id", :url    => self.send("update_#{@supply_sub_category_type.name.tableize}_path"),
                                                                                    :update => "#{@supply_type.name.underscore}_supply_sub_category_id",
                                                                                    :with   => 'id') %>
          <% else %>
            <%= strong supply.supply_category.name %>
          <% end %>
        </p>
      </div>
      
      <div>
        <p>
          <%= form.label :supply_sub_category_id %>
          <% if is_form_view? %>
            <%
            sub_category_select_id   = "#{@supply_type.name.underscore}_supply_sub_category_id"
            sub_category_select_name = "#{@supply_type.name.underscore}[supply_sub_category_id]"
            sub_category_select_disabled = supply.has_been_used? ? "disabled=\"disabled\"" : ""
            %>
            <select id="<%= sub_category_select_id %>" name="<%= sub_category_select_name %>" <%= sub_category_select_disabled %>>
              <%= render :partial => 'supply_categories/supply_sub_categories', :object => supply.supply_category ? supply.supply_category.children.enabled : [],
                                                                                :locals => { :current => supply.supply_sub_category_id } %>
            </select>
            <%= observe_field("#{@supply_type.name.underscore}_supply_sub_category_id", :url    => self.send("update_#{@supply_type.name.underscore}_supply_sizes_path"),
                                                                                        :update => :supplies_supply_sizes,
                                                                                        :with   => 'parent_id') %>
            <%= observe_field("#{@supply_type.name.underscore}_supply_sub_category_id", :url    => self.send("update_#{@supply_type.name.underscore}_unit_measure_path"),
                                                                                        :with   => 'id') %>
          <% else %>
            <%= strong supply.supply_sub_category.name %>
          <% end %>
        </p>
      </div>
      
      <div>
        <p>
          <%= form.label :name %>
          <%= form.form_or_view(form.text_field(:name, :disabled => supply.has_been_used?), :name) %>
        </p>
      </div>
    </fieldset>
    
    <fieldset>
      <legend>Spécificités</legend>
      
      <div id="supplies_supply_sizes">
        <%= render :partial => 'supplies_supply_sizes/supplies_supply_sizes_list', :object => @supplies_supply_sizes,
                                                                                   :locals => { :supply => supply } %>
      </div>
    </fieldset>
    
    <fieldset class="presentation_in_columns">
      <legend>Autres caractéristiques</legend>
      
      <p>
        <%= form.label :measure %>
        <%= form.form_or_view(form.text_field(:measure, :size => 8, :value => supply.measure, :disabled => supply.has_been_used?), :measure) %>&#160;<%= display_supply_unit_measure(supply) %>
      </p>
      <p>
        <%= form.label :unit_mass %>
        <%= form.form_or_view(form.text_field(:unit_mass, :size => 8, :value => supply.unit_mass, :disabled => supply.has_been_used?), :unit_mass) %>&#160;kg
      </p>
      <p>
        <%= form.label :packaging %>
        <%= form.form_or_view(form.text_field(:packaging, :size => 8, :value => supply.packaging), :packaging) %><%= "&#160;par lot" if form.form_view? or !supply.packaging.blank? %>
      </p>
      <p>
        <%= form.label :threshold %>
        <%= form.form_or_view(form.text_field(:threshold, :size => 8, :value => supply.threshold), :threshold) %>
      </p>
    </fieldset>
    
    <% unless supply.new_record? %>
      <h2>Statistiques</h2>
      <div class="presentation_in_columns">
        <div>
          <p>
            <%= form.label :average_unit_price %>
            <%= form.strong number_with_precision(supply.average_unit_price, 2) %> &euro;
          </p>
          
          <p>
            <%= form.label :average_measure_price %>
            <%= form.strong number_with_precision(supply.average_measure_price, 2) %> &euro;/<%= display_supply_unit_measure(supply) %>
          </p>
        </div>
        
        <div>
          <p>
            <%= form.label :higher_unit_price %>
            <%= form.strong number_with_precision(supply.higher_unit_price, 2) %> &euro;
          </p>
          
          <p>
            <%= form.label :higher_measure_price %>
            <%= form.strong number_with_precision(supply.higher_measure_price, 2) %> &euro;/<%= display_supply_unit_measure(supply) %>
          </p>
        </div>
      </div>
      
      <h2>Stock actuel</h2>
      <div class="presentation_in_columns">
        <div>
          <p>
            <%= form.label :stock_quantity %>
            <%= form.strong :stock_quantity %>
          </p>
          <p>
            <%= form.label :stock_value %>
            <%= form.strong number_with_precision(supply.stock_value, 2) %> &euro;
          </p>
          <p>
            <%= form.label :average_unit_value %>
            <%= form.strong number_with_precision(supply.average_unit_stock_value, 2) %> &euro;
          </p>
        </div>
        
        <div>
          <p>
            <%= form.label :stock_measure %>
            <%= form.strong number_with_precision(supply.stock_measure, 2) %> <%= display_supply_unit_measure(supply) %>
          </p>
          <p>
            <%= form.label :stock_mass %>
            <%= form.strong number_with_precision(supply.stock_mass, 2) %> kg
          </p>
        </div>
      </div>
    <% end %>
    
    <h2>Fournisseurs</h2>
    <div class="autoscroll">
      <%= display_supplier_supply_list(supply)  %>
      <%= display_supplier_supply_add_button(supply) if is_form_view? %>
    </div>
    
    <%= form.form_buttons %>
  <% end %>
</div>
