<% content_for :header do %>
  <%= stylesheet_link_tag_with_theme_support 'logistics/supply' %>
<% end %>

<% unless supply.new_record? %>
  <% add_contextual_menu_item supply.class.human_name do %>
    <% supply_action_buttons(supply).each do |button| %>
      <%= button %>
    <% end %>
  <% end %>
<% end %>

<% unless supply.new_record? %>
  <% add_contextual_menu_item supply.supply_sub_category.class.human_name do %>
    <% supply_sub_category_action_buttons(supply.supply_sub_category).each do |button| %>
      <%= button %>
    <% end %>
  <% end %>
<% end %>

<% unless supply.new_record? %>
  <% add_contextual_menu_item supply.supply_category.class.human_name do %>
    <% supply_category_action_buttons(supply.supply_category).each do |button| %>
      <%= button %>
    <% end %>
  <% end %>
<% end %>

<% add_contextual_menu_item :useful_links do %>
  <%= display_supply_list_button(@supply_class) %>
<% end %>

<%
sub_category_select_id   = "#{@supply_class.name.underscore}_supply_sub_category_id"
sub_category_select_name = "#{@supply_class.name.underscore}[supply_sub_category_id]"

supply_type_select_id   = "#{@supply_class.name.underscore}_supply_type_id"
supply_type_select_name = "#{@supply_class.name.underscore}[supply_type_id]"

supply_type_input_id   = "#{@supply_class.name.underscore}_supply_type_name"
supply_type_input_name = "#{@supply_class.name.underscore}[supply_type_name]"
%>

<div class="presentation_medium">
  <h2>Caractéristiques</h2>
  <% form_for(supply) do |form| %>
    <%= form.error_messages %>
    
    <fieldset class="presentation_in_columns small">
      <legend>Référencement</legend>
      
      <% unless supply.new_record? %>
        <p>
          <%= form.label :reference %>
          <%= strong supply.reference %>
        </p>
      <% end %>
      
      <div>
        <p>
          <%= form.label :supply_category_id %>
          <% if is_form_view? and supply.new_record? %>
            <%= form.collection_select :supply_category_id, @supply_categories, :id, :name, { :include_blank => "Veuillez choisir une famille" } %>
            <%= observe_field("#{@supply_class.name.underscore}_supply_category_id", :url    => self.send("update_#{@supply_sub_category_class.name.tableize}_path"),
                                                                                    :update => "#{@supply_class.name.underscore}_supply_sub_category_id",
                                                                                    :with   => 'id') %>
          <% else %>
            <%= strong supply.supply_category.name %>
          <% end %>
        </p>
      </div>
      
      <div>
        <p>
          <%= form.label :supply_sub_category_id %>
          <% if is_form_view? and supply.new_record? %>
            <select id="<%= sub_category_select_id %>" name="<%= sub_category_select_name %>">
              <%= render :partial => 'supply_categories/supply_sub_categories', :object => supply.supply_category ? supply.supply_category.children : [],
                                                                                :locals => { :current => supply.supply_sub_category_id } %>
            </select>
            <%= observe_field("#{@supply_class.name.underscore}_supply_sub_category_id", :url    => self.send("update_#{@supply_type_class.name.tableize}_path"),
                                                                                        :update => supply_type_select_id,
                                                                                        :with   => 'id') %>
            <%= observe_field("#{@supply_class.name.underscore}_supply_sub_category_id", :url    => self.send("update_#{@supply_class.name.underscore}_supply_sizes_path"),
                                                                                        :update => :supplies_supply_sizes,
                                                                                        :with   => 'parent_id') %>
            <%= observe_field("#{@supply_class.name.underscore}_supply_sub_category_id", :url    => self.send("update_#{@supply_class.name.underscore}_unit_measure_path"),
                                                                                        :with   => 'id') %>
          <% else %>
            <%= strong supply.supply_sub_category.name %>
          <% end %>
        </p>
      </div>
      
      <div>
        <p>
          <%= form.label :supply_type %>
          <% if is_form_view? and supply.new_record? %>
            <span class="supply_type_name_select_container">
              <select id="<%= supply_type_select_id %>" name="<%= supply_type_select_name %>" class="supply_type_id_input" onchange="if (this.value == '-1') { this.clear().up('.supply_type_name_select_container').hide().up().down('.supply_type_name_input_container').show().down('.supply_type_name_input').focus(); } else { }">
                <%= render :partial => 'supply_types/supply_types', :object => supply.supply_sub_category ? supply.supply_sub_category.supply_types : [],
                                                                    :locals => { :current => supply.supply_type_id } %>
              </select>
            </span>
            <span class="supply_type_name_input_container" style="display:none">
              <input id="<%= supply_type_input_id %>" name="<%= supply_type_input_name %>" class="supply_type_name_input" type="text" size="16" autocomplete="off"/>
              <%= link_to image_tag("cross_16x16.png", :alt => "Annuler", :title => "Annuler"), '#', :onclick => "var input_container = this.up('.supply_type_name_input_container'); input_container.down('.supply_type_name_input').clear(); input_container.hide().up().down('.supply_type_name_select_container').show().down('select').focus();; return false;" %>
            </span>
          <% else %>
            <%= strong supply.supply_type.name %>
          <% end %>
        </p>
      </div>
    </fieldset>
    
    <fieldset>
      <legend>Spécificités</legend>
      
      <div id="supplies_supply_sizes">
        <%= render :partial => 'supplies_supply_sizes/supplies_supply_sizes_list', :object => @supplies_supply_sizes,
                                                                                   :locals => { :supply => supply } %>
      </div>
    </fieldset>
    
    <fieldset class="presentation_in_columns">
      <legend>Autres caractéristiques</legend>
      
      <p>
        <%= form.label :measure %>
        <%= form.form_or_view(form.text_field(:measure, :size => 8, :value => supply.measure, :disabled => supply.has_been_used?), :measure) %>&#160;<%= display_supply_unit_measure(supply) %>
      </p>
      <p>
        <%= form.label :unit_mass %>
        <%= form.form_or_view(form.text_field(:unit_mass, :size => 8, :value => supply.unit_mass, :disabled => supply.has_been_used?), :unit_mass) %>&#160;kg
      </p>
      <p>
        <%= form.label :packaging %>
        <%= form.form_or_view(form.text_field(:packaging, :size => 8, :value => supply.packaging), :packaging) %><%= "&#160;par lot" if form.form_view? or !supply.packaging.blank? %>
      </p>
      <p>
        <%= form.label :threshold %>
        <%= form.form_or_view(form.text_field(:threshold, :size => 8, :value => supply.threshold), :threshold) %>
      </p>
    </fieldset>
    
    <% unless supply.new_record? %>
      <h2>Statistiques</h2>
      <div class="presentation_in_columns">
        <div>
          <p>
            <%= form.label :average_unit_price %>
            <%= form.strong number_with_precision(supply.average_unit_price, :precision => 2) %> &euro;
          </p>
          
          <p>
            <%= form.label :average_measure_price %>
            <%= form.strong number_with_precision(supply.average_measure_price, :precision => 2) %> &euro;/<%= display_supply_unit_measure(supply) %>
          </p>
        </div>
        
        <div>
          <p>
            <%= form.label :higher_unit_price %>
            <%= form.strong number_with_precision(supply.higher_unit_price, :precision => 2) %> &euro;
          </p>
          
          <p>
            <%= form.label :higher_measure_price %>
            <%= form.strong number_with_precision(supply.higher_measure_price, :precision => 2) %> &euro;/<%= display_supply_unit_measure(supply) %>
          </p>
        </div>
      </div>
      
      <h2>Stock actuel</h2>
      <div class="presentation_in_columns">
        <div>
          <p>
            <%= form.label :stock_quantity %>
            <%= form.strong :stock_quantity %>
          </p>
          <p>
            <%= form.label :stock_value %>
            <%= form.strong number_with_precision(supply.stock_value, :precision => 2) %> &euro;
          </p>
          <p>
            <%= form.label :average_unit_value %>
            <%= form.strong number_with_precision(supply.average_unit_stock_value, :precision => 2) %> &euro;
          </p>
        </div>
        
        <div>
          <p>
            <%= form.label :stock_measure %>
            <%= form.strong number_with_precision(supply.stock_measure, :precision => 2) %> <%= display_supply_unit_measure(supply) %>
          </p>
          <p>
            <%= form.label :stock_mass %>
            <%= form.strong number_with_precision(supply.stock_mass, :precision => 2) %> kg
          </p>
        </div>
      </div>
    <% end %>
    
    <h2>Fournisseurs</h2>
    <div class="autoscroll">
      <%= display_supplier_supply_list(supply)  %>
      <%= display_supplier_supply_add_button(supply) if is_form_view? %>
    </div>
    
    <%= form.form_buttons %>
  <% end %>
</div>
