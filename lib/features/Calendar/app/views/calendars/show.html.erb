<html>
<head>
<%= javascript_include_tag :defaults %>
<script src="/javascripts/resize.js" type="text/javascript"></script>

<style>
div {
//	border: 1px solid;
}
#top {
	height: 150px;
	width: 99%;
}
#top h1 {
	text-align: center;
}
#top #group_day {
	margin-left: 40px;
	margin-right: -10px;
}
#top #group_day .day {
	float:left;
	width: 14.285714285714286%;
	text-align: center;
}
#calendar {
	position: absolute;
	left: 0px;
	right: 0px;
	top: 150px;
	bottom: 0px;
}
#calendar #scroll {
	overflow: auto;
	width: 100%;
	height: 100%;
}
#calendar #scroll #hour_column {
	width: 50px;
	float: left;
	text-align: center;
	color: #BCBAB5;
}
#calendar #scroll .hour {
	height: 60px;
}
#calendar #scroll #grid {
	position: relative;
	margin-left: 50px;
	right: 0px;
	height: 1440px;
	border: 1px solid gray;
}
//#calendar #grid #mon {
	position: absolute;
	left: <%= (600 if @date.wday == 0) || (@date.wday * 100 - 100) %>px;
	height: 1440px;
	width: 100px;
	background-color: #DFDBDE;
	z-index: -100;
}
#calendar #scroll #grid .day_grid_border {
	border: 1px solid gray;
	border-top: none;
	border-bottom: none;
	width: 100%;
	height: 100%;
}
#calendar #scroll #grid .day_grid {
	float:left;
	width: 14.28%;
	height: 100%;
	z-index: -100;
	background: url('/images/grid_repeat-x.gif') repeat;
}
.event {
	border: 1px solid black;
	min-height: 22px;
	padding: 4px 0px;
	text-align: center;
	font-size: 10px;
	color: white;
	cursor: move;
	-moz-border-radius: 8px;
	opacity: 0.8;
	-moz-opacity: 0.8;
	filter:alpha(opacity=80);
}
.event_content {
	height: 100%;
}
</style>
<script type="text/javascript">
events = new Array();
draggables_events = new Array();

/* Functions */

function grid_area(draggable) {
	var cal_event = draggable.element;
	switch (cal_event.ancestors()[1].id) {
		case "Mon":
			var coeff = 0;
		break;
		case "Tue":
			var coeff = 1;
		break;
		case "Wed":
			var coeff = 2;
		break;
		case "Thu":
			var coeff = 3;
		break;
		case "Fri":
			var coeff = 4;
		break;
		case "Sat":
			var coeff = 5;
		break;
		case "Sun":
			var coeff = 6;
		break;
	};
	var grid = document.getElementById('grid');

	var left_size = cal_event.style.left.replace("px", "");
	var left_max_size = (6 - coeff) * (cal_event.offsetWidth);
	if (left_size > left_max_size) {
		cal_event.style.left = left_max_size + "px";
	};
	var left_min_size = - coeff * (cal_event.offsetWidth);
	if (left_size < left_min_size) {
		cal_event.style.left = left_min_size + "px";
	};
	var top_size = cal_event.style.top.replace("px","");
	var top_max_size = grid.offsetHeight - cal_event.offsetHeight - 2;
	if (top_size > top_max_size) {
		cal_event.style.top = top_max_size + "px";
	};
	if (top_size < 0) {
		cal_event.style.top = "0px";
	};
}

function update_time (id) {
	element = document.getElementById(id);
	var left_size = element.style.left.replace("px", "");
	var top_size = element.style.top.replace("px", "");
	var height = element.offsetHeight;
	var start_at_hour = ((top_size - top_size % 60) / 60);
	var end_at_hour = ((height - height % 60) / 60) + start_at_hour;
	var start_at_min = (top_size % 60);
	var end_at_min = (height % 60) + start_at_min;
	var start_at = start_at_hour + "h" + start_at_min;
	var end_at = end_at_hour + "h" + end_at_min;
	document.getElementById(id + '_content').childNodes[0].innerHTML = start_at;
	document.getElementById(id + '_content').childNodes[2].innerHTML = end_at;
}

function add_event (id, title, top, left, height, color, week_day) {
	var grid_day = document.getElementById(week_day).childNodes[1];
	var left = left * document.getElementById('Mon').offsetWidth;
	left= 0;
	for (var i=0; i < events.length; i++) {
		if (events[i] == 'event' + id) {
			grid_day.removeChild(document.getElementById(events[i]));
			events.splice(i, 1);
		};
	};
	var elm_id = 'event' + id
	var event_div = document.createElement("div");
	var event_content = document.createElement("div");
	
	event_div.setAttribute('id', elm_id);
	event_div.setAttribute('class', 'event');
	event_div.setAttribute('style', 'top: ' + top + 'px; left: ' + left + 'px; height: ' + height + 'px; background-color: ' + color);
	
	event_content.setAttribute('id', elm_id + '_content');
	event_content.setAttribute('class', 'event_content');
	
	event_content.innerHTML = "<span name='start_at' class='start_at'></span>-<span name='end_at' class='end_at'></span><br /><span name='title' class='title'>" + title + "</span>";
	
	event_div.appendChild(event_content);
	grid_day.appendChild(event_div);
	
  Effect.Pulsate(elm_id, { pulses: 3, duration: 1.5 });
	add_resizeable(elm_id);
  new Resizeable(elm_id, {
  	left:0,
  	right:0,
  	top: 4,
  	bottom: 4,
  	resize: function() {
  		update_time(elm_id);
  	}
  });
  update_time(elm_id);
	events.push(elm_id);
//	alert(events.length);
	windows_width = document.getElementById('Mon').offsetWidth;
	windows_height = document.getElementById('Mon').offsetHeight;
}

function resize_events () {
	for (var i=0; i < draggables_events.length; i++) {
		draggables_events[i].destroy();
	};
	for (var i=0; i < events.length; i++) {
		add_resizeable(events[i]);
	};
}

function add_resizeable (elm_id) {
  draggables_events.push(new Draggable(elm_id, {
  	handle: elm_id + '_content',
  	snap: [document.getElementById('Mon').offsetWidth, 15],
  	change: function(draggable) {
  		grid_area(draggable);
  	},
  	onDrag: function(draggable) {
  		update_time(draggable.element.id);
  	},
		onEnd: function(draggable) {
			change_day_events(draggable);
		}
  }));
}

function change_day_events (draggable) {
	var	cal_event = draggable.element;
	var left_size = cal_event.style.left.replace("px","");
	switch (cal_event.ancestors()[1].id) {
		case "Mon":
			var day_num = 0;
		break;
		case "Tue":
			var day_num = 1;
		break;
		case "Wed":
			var day_num = 2;
		break;
		case "Thu":
			var day_num = 3;
		break;
		case "Fri":
			var day_num = 4;
		break;
		case "Sat":
			var day_num = 5;
		break;
		case "Sun":
			var day_num = 6;
		break;
	};
	var target_day = day_num + (left_size / cal_event.ancestors()[1].offsetWidth);
	switch (target_day) {
		case 0:
			var day = "Mon";
		break;
		case 1:
			var day = "Tue";
		break;
		case 2:
			var day = "Wed";
		break;
		case 3:
			var day = "Thu";
		break;
		case 4:
			var day = "Fri";
		break;
		case 5:
			var day = "Sat";
		break;
		case 6:
			var day = 6;
		break;
	};
	cal_event.style.left = 0;
	document.getElementById(day).childNodes[1].appendChild(cal_event);
}
</script>
</head>
<body onLoad="<%= get_events_function %>" onResize="resize_events();">
	<div id="top">
		<h1><%= @calendar.title %> - <%= $month_fr[@date.month - 1] %> <%= @date.year %> (semaine <%= @date.week %>)</h1>
		<p>
			<input type="button" value="Télécharger les événements" onClick="<%= get_events_function %>" /> | 
			<%= link_to "Aujourd'hui", :id => params[:id],  :period => params[:period], :year => Date::today.year, :month => Date::today.month, :day => Date::today.day %>
		</p>
		<div id="group_day">
			<% date = @date.beginning_of_week %>
			<% 7.times do %>
			<div class="day"><%= $day_fr[date.wday] + " " + date.day.to_s %></div>
			<% date += 1.days %>
			<% end %>
		</div>
	</div>

	<div id="calendar">
		<div id="scroll">
			<div id="hour_column">
			<% 24.times do |i| %>
			<%= "<div class=\"hour\">#{i}h00</div>" %>
			<% end %>
			</div>
			<div id="grid">
				<% date = @date.beginning_of_week %>
				<% 7.times do %>
				<div id="<%= date.strftime('%a') %>" class="day_grid">
						<div class="day_grid_border"></div>
				</div>
				<% date += 1.days %>
				<% end %>
			</div>
		</div>
	</div>
</body>
</html>