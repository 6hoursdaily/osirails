<html>
<head>
<%= javascript_include_tag :defaults %>
<script src="/javascripts/resize.js" type="text/javascript"></script>

<style>
div {
//	border: 1px solid;
}
h1 {
	text-align: center;
}
#group_day {
	margin-left: 40px;
	margin-right: -10px;
}
#group_day .day {
	float:left;
	width: 14.285714285714286%;
	text-align: center;
}
#calendar {
	position: absolute;
	left: 0px;
	right: 0px;
	top: 150px;
	bottom: 0px;
}
#calendar #scroll {
	overflow: auto;
	width: 100%;
	height: 100%;
}
#calendar #scroll #hour_column {
	width: 50px;
	float: left;
	text-align: center;
	color: #BCBAB5;
}
#calendar #scroll .hour {
	height: 60px;
}
#calendar #scroll #grid_week {
	position: relative;
	margin-left: 50px;
	right: 0px;
	height: 1440px;
	border: 1px solid gray;
}
#calendar #scroll #grid_week .day_grid_border {
	border: 1px solid gray;
	border-top: none;
	border-bottom: none;
	width: 100%;
	height: 100%;
}
#calendar #scroll #grid_week .day_grid {
	float:left;
	width: 14.285714285714286%;
	height: 100%;
	z-index: -100;
	background: url('/images/grid_repeat-x.gif') repeat;
}
#calendar #scroll #grid_day {
	position: relative;
	margin-left: 50px;
	right: 0px;
	height: 1440px;
	border: 1px solid gray;
}
#calendar #scroll #grid_day .day_grid_border {
	border: 1px solid gray;
	border-top: none;
	border-bottom: none;
	width: 100%;
	height: 100%;
}
#calendar #scroll #grid_day .day_grid {
	float:left;
	width: 100%;
	height: 100%;
	z-index: -100;
	background: url('/images/grid_repeat-x.gif') repeat;
}
ul {
	padding: 0px;
	margin: 0px;
}
li {
	position: absolute;
	width: 0px;
	display:inline;
//	background-color : blue;
	width: 14.2%;
}
.event {
	position: relative;
	width: 100%;
	border: 1px solid black;
	padding: 4px 0px;
	min-height: 20px;
	text-align: center;
	font-size: 10px;
	color: white;
	cursor: move;
	-moz-border-radius: 8px;
	opacity: 0.8;
	-moz-opacity: 0.8;
	filter:alpha(opacity=80);
}
.event_content {
	height: 100%;
}
</style>
<script type="text/javascript">
events = new Array();
draggables_events = new Array();

/* Functions */

function grid_area(draggable) {
	var cal_event = draggable.element;
	var coeff = dayname_to_daynum (cal_event.ancestors()[0].ancestors()[0].ancestors()[1].id);
	var grid = document.getElementById('grid');

	var left_size = cal_event.style.left.replace("px", "");
	var left_max_size = (6 - coeff) * (cal_event.offsetWidth);
	if (left_size > left_max_size) {
		cal_event.style.left = left_max_size + "px";
	};
	var left_min_size = - coeff * (cal_event.offsetWidth);
	if (left_size < left_min_size) {
		cal_event.style.left = left_min_size + "px";
	};
	var top_size = cal_event.style.top.replace("px","");
	var top_max_size = grid.offsetHeight - cal_event.offsetHeight - 2;
	if (top_size > top_max_size) {
		cal_event.style.top = top_max_size + "px";
	};
	if (top_size < 0) {
		cal_event.style.top = "0px";
	};
}

function update_time (id) {
	element = document.getElementById(id);
	var left_size = element.style.left.replace("px", "");
	var top_size = element.style.top.replace("px", "");
	var height = element.offsetHeight;
	var start_at_hour = ((top_size - top_size % 60) / 60);
	var end_at_hour = ((height - height % 60) / 60) + start_at_hour;
	var start_at_min = (top_size % 60);
	var end_at_min = (height % 60) + start_at_min;
	var start_at = start_at_hour + "h" + start_at_min;
	var end_at = end_at_hour + "h" + end_at_min;
	document.getElementById(id + '_content').childNodes[0].innerHTML = start_at;
	document.getElementById(id + '_content').childNodes[2].innerHTML = end_at;
}

function add_event (id, title, top, height, color, week_day) {
	var grid_day = document.getElementById(week_day).childNodes[1];
	for (var i=0; i < events.length; i++) {
		if (events[i] == 'event' + id) {
			grid_day.removeChild(document.getElementById(events[i]));
			events.splice(i, 1);
		};
	};
	var elm_id = 'event' + id
	var event_div = document.createElement("div");
	var event_content = document.createElement("div");
	var li = document.createElement("li");
	
	event_div.setAttribute('id', elm_id);
	event_div.setAttribute('class', 'event');
	event_div.setAttribute('style', 'top: ' + top + 'px; height: ' + height + 'px; background-color: ' + color);
	
	event_content.setAttribute('id', elm_id + '_content');
	event_content.setAttribute('class', 'event_content');
	
	event_content.innerHTML = "<span name='start_at' class='start_at'></span>-<span name='end_at' class='end_at'></span><br /><span name='title' class='title'>" + title + "</span>";
	
	event_div.appendChild(event_content);
	li.appendChild(event_div);
	grid_day.childNodes[0].appendChild(li);
	
  //Effect.Pulsate(elm_id, { pulses: 2, duration: 1 });

	add_draggable(elm_id);
  new Resizeable(elm_id, {
  	left:0,
  	right:0,
  	top: 0,
  	bottom: 4,
		minHeight: 19,
  	resize: function() {
  		update_time(elm_id);
			save_event(elm_id);
  	}
  });
  update_time(elm_id);
	events.push(elm_id);
	windows_width = document.getElementById('Mon').offsetWidth;
	windows_height = document.getElementById('Mon').offsetHeight;
}

function resize_events () {
	for (var i=0; i < draggables_events.length; i++) {
		draggables_events[i].destroy();
	};
	for (var i=0; i < events.length; i++) {
		add_draggable(events[i]);
	};
}

function add_draggable (elm_id) {
  draggables_events.push(new Draggable(elm_id, {
  	handle: elm_id + '_content',
  	snap: [document.getElementById('Mon').offsetWidth, 15],
  	change: function(draggable) {
  		grid_area(draggable);
  	},
  	onDrag: function(draggable) {
  		update_time(draggable.element.id);
  	},
		onEnd: function(draggable) {
			change_day_events(draggable);
			save_event(draggable.element.id);
		}
  }));
}

function change_day_events (draggable) {
	var	cal_event = draggable.element;
	var left_size = cal_event.style.left.replace("px","");
	var day_num = dayname_to_daynum (cal_event.ancestors()[0].ancestors()[0].ancestors()[1].id);
	var target_day = day_num + (left_size / cal_event.ancestors()[1].offsetWidth);
	var day = daynum_to_dayname(target_day);
	cal_event.style.left = 0;
	document.getElementById(day).childNodes[1].childNodes[0].appendChild(cal_event.ancestors()[0]);
}

function show_edit_box (argument) {
	// body...
}

function daynum_to_dayname (daynum) {
	switch (daynum) {
		case 0:
			var dayname = "Mon";
		break;             
		case 1:            
			var dayname = "Tue";
		break;             
		case 2:            
			var dayname = "Wed";
		break;             
		case 3:            
			var dayname = "Thu";
		break;             
		case 4:            
			var dayname = "Fri";
		break;             
		case 5:            
			var dayname = "Sat";
		break;             
		case 6:            
			var dayname = "Sun";
		break;
	};
	return dayname;
}

function dayname_to_daynum (dayname) {
	switch (dayname) {
		case "Mon":
			var daynum = 0;
		break;
		case "Tue":
			var daynum = 1;
		break;
		case "Wed":
			var daynum = 2;
		break;
		case "Thu":
			var daynum = 3;
		break;
		case "Fri":
			var daynum = 4;
		break;
		case "Sat":
			var daynum = 5;
		break;
		case "Sun":
			var daynum = 6;
		break;
	};
	return daynum;
}

function save_event (elm_id) {
	cal_event = document.getElementById(elm_id);
	event_id = elm_id.substr(13, elm_id.length - 13);
	wday = dayname_to_daynum (cal_event.ancestors()[0].ancestors()[0].ancestors()[1].id);
	if (new Ajax.Request('/calendars/update/' + event_id +'?period=week&top=' + cal_event.style.top.replace("px", "") +'&height=' + (parseInt(cal_event.style.height) + 10) + '&wday=' + wday, {asynchronous:true, evalScripts:true})) {
		// TODO 
	};
}
</script>
</head>
<body onLoad="<%= get_events_function %>" onResize="resize_events();">
	<%= render_calendar(params[:period]) %>
	<div id="edit_box">
		<%= render :action => :edit %>
	</div>
</body>
</html>