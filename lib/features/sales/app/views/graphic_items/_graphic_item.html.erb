<% content_for :header do -%>
  <%= javascript_include_tag "sales/tab_navigation" %>
  <%= javascript_include_tag "sales/#{graphic_item.class.name.underscore}" %>
  <%= stylesheet_link_tag_with_theme_support 'core/has_resources/has_resources' %>
<% end -%>

<%
  graphic_item_headers = { :graphic_item_informations          => "Informations principales",
                           :graphic_item_graphic_item_versions => "Versions (#{graphic_item.graphic_item_versions.count})",
                           :graphic_item_miscellaneous         => "Divers" }

  graphic_item_errors  = { :graphic_item_informations          => graphic_item.errors.on(:graphic_item) ? ' errors' : ''}
  
  disabled = graphic_item.new_record? ? "disabled" : ""
%>

<div class="presentation_medium graphic_item root_nav">
  <ul class="graphic_item_nav tab_nav">
    <li class="graphic_item_informations<%= graphic_item_errors[:graphic_item] %> selected"><%= graphic_item_headers[:graphic_item_informations] %></li>
    <li class="graphic_item_graphic_item_versions <%= disabled %>"><%= graphic_item_headers[:graphic_item_graphic_item_versions] %></li>
    <li class="graphic_item_miscellaneous <%= disabled %>"><%= graphic_item_headers[:graphic_item_miscellaneous] %></li>
  </ul>
  <% action = graphic_item.new_record? ? :create : :update %>
  <% form_for(graphic_item, :url => { :controller => "#{graphic_item.class.name.tableize}", :action => action}, :html => { :multipart => true, :class => is_form_view? ? (graphic_item.new_record? ? "new_#{graphic_item.class.name.underscore}" : "edit_#{graphic_item.class.name.underscore}") : "skip_prevent_close" }) do |f| %>
    <%= f.error_messages(:skip_links => true) %>

    <h2 class="graphic_item_informations"><%= graphic_item_headers[:graphic_item_informations] %></h2>
    <div class="graphic_item_informations section_nav selected">
      <% if graphic_item.class.name == "Mockup" %>
        <p>
          <%= f.label :product %>
          <% if graphic_item.new_record? %>
            <%= f.collection_select(:product_id, @products, :id, :name, { :prompt => "---" }) %>
          <% else %>
            <%= f.strong(graphic_item.product.name) %>
          <% end %>
        </p>
      <% end %>
      <p>
        <%= f.label :name %>
        <% if graphic_item.new_record? %>
          <%= f.text_field(:name) %>
        <% else %>
          <% unless graphic_item.is_in_spool("image") or graphic_item.is_in_spool("source")%>
            <%= f.form_or_view(f.text_field(:name),:name) %>
          <% else %>
            <% if is_form_view? %>
              <%= f.text_field(:name, {:disabled => "true"}) %>
              <span class="help_text">
                La modification du nom est impossible car la maquette est présente dans la file d'attente d'un ou plusieurs utilisateurs
              </span>
            <% else %>
              <%= f.strong graphic_item.name %>
            <% end %>
          <% end %>
        <% end %>
      </p>
      <p>
        <%= f.label :description %>
        <%= f.form_or_view(f.autoresize_text_area(:description),:description) %>
      </p>
      <p>
        <%= f.label "#{graphic_item.class.name.underscore}_type".to_sym %>
        <% if graphic_item.new_record? %>
          <%= f.collection_select("#{graphic_item.class.name.underscore}_type_id".to_sym, @graphic_item_types, :id, :name, { :prompt => "---" }) %>
        <% else %>
          <%= f.strong(graphic_item.send("#{graphic_item.class.name.underscore}_type").name) %>
        <% end %>
      </p>
      <% unless graphic_item.new_record? %>
        <p>
          <%= f.label :version %>
          <%= f.strong graphic_item.current_version.created_at.humanize %>
        </p>
        <div class="resource document">
          <div class="thumb">
            <%= image_tag graphic_item.current_image.url(:thumb) %>
          </div>
          <div class="details">
            <h1><%= graphic_item.class.form_labels[:image] %></h1>
            <%= link_to f.strong("Télécharger"), graphic_item.current_image.url %>
            <% unless is_form_view? %>
              / <%= display_graphic_item_summary_image_spool_actions(graphic_item) %>
            <% end %>
            <h1><%= graphic_item.class.form_labels[:source] %></h1>
            <% if graphic_item.current_version.source_file_name %>
              <%= link_to f.strong("Télécharger"), graphic_item.current_source.url %>
              <% unless is_form_view? %>
                / <%= display_graphic_item_summary_source_spool_actions(graphic_item) %>
              <% end %>
            <% else %>
              <%= f.strong("aucun") %>
            <% end %>
          </div>
        </div>
      <% end %>
      <% if is_form_view? and !graphic_item.new_record? %>
        <p>
          <%= f.label :should_add_version %>
          <%= radio_button_tag "action", "should_add_version", true, {:onclick => 'addOrChangeVersion("add",' + graphic_item.current_version_id.to_s + ' )'} %>
          <%= f.label :should_change_version %>
          <%= radio_button_tag "action", "should_change_version", false, {:onclick => 'addOrChangeVersion("change",' + graphic_item.current_version_id.to_s + ' )'} %>
        </p>
        <% if graphic_item.is_in_spool("image") or graphic_item.is_in_spool("source")%>
          <p class="spool_warning">
            <%= "Attention, l'ajout ou le changement d'une version entraînera le retrait de la version actuelle dans la file d'attente de tous les utilisateurs" %>
          </p>
        <% end %>
      <% end %>
      <% if is_form_view? and graphic_item.new_record? %>
        <p>
          <%= f.label :graphic_unit_measure %>
          <%= f.collection_select(:graphic_unit_measure_id, @graphic_unit_measures, :id, :name, { :prompt => "---" }) %>
        </p>
      <% end %>
      <% if is_form_view? %>  
        <div id="add_version_div">
          <p id="new_image_paragraph">
            <%= f.label :image %>
            <%= f.form_or_view(f.file_field(:graphic_item_version_attributes, {:id => "#{graphic_item.class.name.underscore}_graphic_item_version_attributes_image", :name => "#{graphic_item.class.name.underscore}[graphic_item_version_attributes][image]"}), :product) %>
          </p>
          <p id="new_source_paragraph">
            <%= f.label :source %>
            <%= f.form_or_view(f.file_field(:graphic_item_version_attributes, {:id => "#{graphic_item.class.name.underscore}_graphic_item_version_attributes_source", :name => "#{graphic_item.class.name.underscore}[graphic_item_version_attributes][source]"}), :product) %>
          </p>  
        </div>
        <% unless graphic_item.new_record? %>
          <div id="change_version_div" style="display:none">
            <p id="change_version_paragraph">
              <%= f.label :change_version %>
              <%= f.collection_select(:current_version_id, @graphic_item_versions, :id, :formatted_created_at) %>
            </p>
          </div>
        <% end %>        
      <% end %>
    </div>
    
    <h2 class="graphic_item_graphic_item_versions"><%= graphic_item_headers[:graphic_item_graphic_item_versions] %></h2>
    <div class="graphic_item_graphic_item_versions section_nav">
      <% if graphic_item.new_record? %>
        <p>Onglet indisponible pendant la cr&eacute;ation</p>
      <% else %>
        <p>
          <%= f.label :graphic_unit_measure %>
          <%= f.strong graphic_item.graphic_unit_measure.name %>
        </p>
        <div id="graphic_item_versions_preview">
          <div id="graphic_item_medium_image">
            <%= image_tag graphic_item.current_image.url(:medium), {:id => "image_tag"} %>
          </div>
          <div id="graphic_item_choice">
            <%= collection_select(nil,:current_version_id, @graphic_item_versions, :id, :formatted_created_at, {}, {:multiple => "multiple", :id => "#{graphic_item.class.name.underscore}_versions", :name => "#{graphic_item.class.name.underscore}_versions"}) %>
            <%= observe_field("#{graphic_item.class.name.underscore}_versions", :url => send("order_#{graphic_item.class.name.underscore}_refresh_links_path",@order.id,graphic_item.id), :with => 'current_version_id')%>
          </div>
        </div>
        <p>
          <%= f.label :image %>
          <%= link_to f.strong("télécharger"), graphic_item.current_image.url, {:id => "image_download_link"}%>
        </p>
        <p id="source_download_link">
          <%= f.label :source %>
          <% if graphic_item.current_version.source_file_name %>
            <%= link_to f.strong("télécharger"), graphic_item.current_source.url %>
          <% else %>
            <%= f.strong("aucun") %>
          <% end %>
        </p>
      <% end %>
    </div>
    
    <h2 class="graphic_item_miscellaneous"><%= graphic_item_headers[:graphic_item_miscellaneous] %></h2>
    <div class="graphic_item_miscellaneous section_nav">
      <% if graphic_item.new_record? %>
        <p>Aucune information diverse disponible</p>
      <% else %>
        <p>
          <%= f.label :created_at %>
          <%= f.strong graphic_item.created_at.humanize %>
        </p>
        <p>
          <%= f.label :creator %>
          <%= link_to "#{graphic_item.creator.employee_name}", graphic_item.creator.employee ? employee_path(graphic_item.creator.employee) : user_path(graphic_item.creator) %>
        </p>
      <% end %>
    </div>
    <% if is_form_view? %>
      <p>
        <%= f.reset 'Réinitialiser' %><%= f.submit button_name %>
      </p>
    <% end %>     
  <% end %>
</div>
