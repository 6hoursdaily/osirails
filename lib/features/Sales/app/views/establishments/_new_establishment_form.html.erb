<div id='<%= "link_add_remove_establishment_#{cpt}"%>'>
    
  <%if error %>
    <!--  store contact in a instance variable to display is error_messages -->
    <% @establishment = @establishment_objects[cpt-1]%>
    <%= error_messages_for("establishment")%>
  <% end %>
  
  <%= link_to_remote("supprimer", :url => {:controller => "establishments", :action => "delete_new_establishment", :id => cpt}, 
      :with => "'number=' + $('new_establishment_number_value').value")%>
</div>

<div id='<%= "new_establishment#{cpt}"%>'>

<% establishment_ = Establishment.new %>
    <% fields_for "customer[establishments]", establishment_ , :index => cpt do |establishment| %>
    <p>
      <%= establishment.label :name, "Nom :" %>
      <%= establishment.text_field :name %>
    </p>

    <p>
      <%= establishment.label :establishment_type_id, "Type d'&eacute;tablissement :" %>
      <%= establishment.select("establishment_type_id", EstablishmentType.find(:all).collect {|a| [ a.name, a.id ] }) %>
    </p>
    
    <% address_ = Address.new unless error %>
    <% fields_for "customer[establishments][#{cpt}][address]", address_ do |address| %>
      
    <p>      
      <%= address.label :address1, "Address1", :id => "customer_establishments_#{cpt}_address_address1" %>
      <%= address.text_field :address1, :id => "customer_establishments_#{cpt}_address_address1" %>
    </p>

    <p>      
      <%= address.label :address2, "Address2", :id => "customer_establishments_#{cpt}_address_address2" %>
      <%= address.text_field :address2, :id => "customer_establishments_#{cpt}_address_address2" %>
    </p>
    <% unless error%>
      <% owner_address = Address.new() %>
    <%else%>
    <%owner_address = Address.new(
      :country_name => params[:customer][:establishments]["#{cpt}"][:address][:country][:name],
      :city_name => (params[:customer][:establishments]["#{cpt}"][:address][:city][:name] unless params[:customer][:establishments]["#{cpt}"][:address][:city].nil?),
      :zip_code => (params[:customer][:establishments]["#{cpt}"][:address][:city][:zip_code] unless params[:customer][:establishments]["#{cpt}"][:address][:city].nil?))%>  
    <%end%>
    <%# puts owner_address.country_name%>

<%= render :partial => 'addresses/address',
      :locals => {:cpt=> cpt, :owner_address => owner_address, :address_name => "customer_establishments_#{cpt}", :error => error}%>

    <p>
      <!-- To know if address will be save -->
      <%= establishment.hidden_field(:valid, :value => 'true', :id => "customer_establishments_#{cpt}_valid")%>
    </p>

    <% end %>

<% end %>

</div>

<% unless error%>
<div id='<%= "link_add_remove_establishment_#{cpt.to_i + 1}"%>'>
    <%=link_to_remote("(ajouter)", :url => {:controller => "establishments", :action => "add_establishment", :cpt => cpt.to_i + 1},
     :with => "'number=' + $('new_establishment_number_value').value")%>
</div>
<%end%>