<div <%= "id=link_add_remove_contact_#{cpt}"%>>
    <%= error_messages_for("new_contact#{cpt}") %>
    <%= link_to_remote("supprimer", :url => {:action => "delete_new_contact", :id => cpt})%>
</div>

<% owner_id ||= params[:owner_id] %>
<div id='<%= "new_contact#{cpt}"%>'>

<div id="contact_<%=cpt%>_input_info" style='display: block;'>
<p><%= label :new_contact, "Nom" %><br/>
<%= my_text_field_with_auto_complete(:contact, :first_name, {:index => cpt,:url => {:controller => 'contacts'}},{
    :select => 'ul_contact_name',
    :after_update_element => "function(){document.getElementById('auto_complete_#{cpt}_select').value = 'true';}",
    :with => "'value='+document.getElementById('new_contact#{cpt}_first_name').value+
    '&owner_id=#{owner_id}'+
    '&owner_type=#{owner_type}'"})%>

<p><%= label :new_contact, "PrÃ©nom" %><br/>
<%= my_text_field_with_auto_complete(:contact, :last_name, {:index => cpt,:url => {:controller => 'contacts'}},{
    :select => 'ul_contact_name',
    :after_update_element => "function(){document.getElementById('auto_complete_#{cpt}_select').value = 'true';}",
    :with => "'value='+document.getElementById('new_contact#{cpt}_last_name').value+
    '&owner_id=#{owner_id}'+
    '&owner_type=#{owner_type}'"})%>

<p><%= label :new_contact, "Email" %><br/>
<%= my_text_field_with_auto_complete(:contact, :email, {:index => cpt,:url => {:controller => 'contacts'}},{
    :select => 'ul_contact_name',
    :after_update_element => "function(){document.getElementById('auto_complete_#{cpt}_select').value = 'true';}",
    :with => "'value='+document.getElementById('new_contact#{cpt}_email').value+
    '&owner_id=#{owner_id}'+
    '&owner_type=#{owner_type}'"})%>


<% # Affectation of variables when an error occure%>
<%if error%>
<%=  javascript_tag "document.getElementById('new_contact#{cpt}_first_name').value = '#{params["new_contact#{cpt}"]["first_name"]}'"%>
<%=  javascript_tag "document.getElementById('new_contact#{cpt}_last_name').value = '#{params["new_contact#{cpt}"]["last_name"]}'"%>
<%=  javascript_tag "document.getElementById('new_contact#{cpt}_email').value = '#{params["new_contact#{cpt}"]["email"]}'"%>
<%=  javascript_tag "document.getElementById('new_contact#{cpt}_jobs').value = '#{params["new_contact#{cpt}"]["jobs"]}'"%>
<%end%>


  <p><%= label :contact, "Job" %><br/>
  <%= text_field("new_contact#{cpt}","jobs") %></p>
 
  <p><%=label :new_contact, "Type de client"%><br/>
  <%= select("new_contact#{cpt}", "contact_type_id", ContactType.find(:all, :conditions => ["owner = ?", owner_type]).collect {|a| [ a.name, a.name]})%></p>
  </div>
  
  <%= hidden_field("auto_complete_#{cpt}", "select", "value" => 'false')%>
  <%= hidden_field("new_contact#{cpt}","id", "value" => '')%>
  <%= hidden_field("valid_contact_#{cpt}", "value", "value" => 'true')%>
  <%= hidden_field("create_contac", "#{cpt}", "value" => "true")%>
  
  <div id="contact_<%=cpt%>_show_info" style='display: none;'></div>
</div>

<%= observe_field("new_contact#{cpt}_first_name",
        :url =>{:controller => "contacts", :action=>'text_field_change', :owner_id => owner_id, :owner_type => owner_type},
        :frequency => 0.5, 
        :with => "'contact_input_info_visibility='+encodeURIComponent(document.getElementById('contact_#{cpt}_input_info').style.display)+ 
        '&value='+encodeURIComponent(value)+
        '&contact_id='+encodeURIComponent(document.getElementById('new_contact#{cpt}_first_name_auto_complete').getElementsByClassName('first_name')[0].getElementsByClassName('selected')[0].getElementsByClassName('contact_id')[0].innerHTML)+
        '&contact_selected='+encodeURIComponent(document.getElementById('auto_complete_#{cpt}_select').value)+
        '&cpt='+encodeURIComponent(#{cpt})")
%>

<%= observe_field("new_contact#{cpt}_last_name",
        :url =>{:controller => "contacts", :action=>'text_field_change', :owner_id => owner_id, :owner_type => owner_type},
        :frequency => 0.5, 
        :with => "'contact_input_info_visibility='+encodeURIComponent(document.getElementById('contact_#{cpt}_input_info').style.display)+ 
        '&value='+encodeURIComponent(value)+
        '&contact_id='+encodeURIComponent(document.getElementById('new_contact#{cpt}_last_name_auto_complete').getElementsByClassName('first_name')[0].getElementsByClassName('selected')[0].getElementsByClassName('contact_id')[0].innerHTML)+
        '&contact_selected='+encodeURIComponent(document.getElementById('auto_complete_#{cpt}_select').value)+
        '&cpt='+encodeURIComponent(#{cpt})")
%>


<%unless error%>
<div <%= "id=link_add_remove_contact_#{cpt.to_i + 1}"%>>
    <%=link_to_remote("(+)", :url => {:controller => "contacts", :action => "add_contact", :cpt => cpt.to_i + 1,
        :owner_id => owner_id, :owner_type => owner_type})%>
</div>

<%end%>