<h4>Modifier un client </h4>

<% form_for(@customer) do |customer| %>
<%= customer.error_messages %>

<%= render :partial => 'thirds/third', :locals => {:third => customer, :type => "client"} %>

<% if @establishments.length > 0 %>
  <% for establishment in @establishments %>
  <%= error_messages_for("establishment#{establishment.id}") %>
  <%= error_messages_for("establishment#{establishment.id}_address")%>
<%end%>
      
    <fieldset>
      <legend> Informations concernant les établissement du client </legend>
      <% for establishment in @establishments %>
       <%unless establishment.activated == false%>
       <div <%= "id='establishment#{establishment.id}'"%>>
      <% cpt ||= 0 %>
      <% cpt += 1 %>
        
      <%= error_messages_for("address") %>

      <% # If it's the first the page is call %>
      <%unless @error%>
      <%establishment_name =establishment.name %>
      <%establishment_type = establishment.establishment_type_id%>
      <%establishment_address1 = establishment.address.address1%>
      <%establishment_address2 = establishment.address.address2%>
      <%end%>
      
      <p><%= label :establishment, "Nom de l'etablissement" %><br/>
      <%= text_field("establishment#{establishment.id}","name","value" => establishment_name) %>
      <p><%= label :establishment, "Type de client" %><br/>
      <%= select("establishment#{establishment.id}", "establishment_type_id",EstablishmentType.find(:all).collect {|a| [ a.wording, a.id ] },:selected => establishment.establishment_type_id)%></p>
      <p><%= label :address, "Address1" %><br/>
      <%= text_field("establishment#{establishment.id}_address","address1", "value" => establishment_address1)%></p>
      <p><%= label :address, "Address2" %><br/>
      <%= text_field("establishment#{establishment.id}_address","address2", "value" => establishment_address2)%></p>
      <p><%= label :address, "city_id" %><br/>
      <%= select("establishment#{establishment.id}_address", "city_id",City.find(:all).collect {|a| [ a.name, a.id ] },:selected => establishment.address.city_id)%></p>
      <br/>
      <%= link_to_remote("supp_form", :url => {:action => "supp_form", :id => establishment.id}) %>
    </div>
    <%end%>
      <% end %>  
      <% end %> 
      
          
       
      <%unless params[:new_establishment_number].nil?%>
      <%new_estbalishment_number = params[:new_establishment_number].keys.last.to_i%>
      <%= hidden_field("new_establishment_number", new_estbalishment_number)%>
        <%new_estbalishment_number.times do |i|%>
          <%=error_messages_for("new_establishment#{i+1}") %>
          <%=error_messages_for("new_establishment_address#{i+1}") %>
        <%end%>
        
        <%end%>
     <fieldset>
        <%cpt = 1%>
        <legend> Ajouter un établissement pour le client </legend>
           <%unless params[:new_establishment_number].nil?%>
          <%new_estbalishment_number.times do |i|%>

          <p><%= label :new_establishment, "Nom du nouvel établissement" %><br/>
          <%= text_field("new_establishment#{i+1}","name")%></p>
          <p><%= label :new_establishment, "Type de client" %><br/>
          <%= select("new_establishment#{i+1}", "establishment_type_id",EstablishmentType.find(:all).collect {|a| [ a.wording, a.id ] },{"include_blank" => 'None'})%></p>
          <p><%= label :new_address, "Address1" %><br/>
          <%= text_field("new_establishment_address#{i+1}","address1")%></p>
          <p><%= label :new_address, "Address2" %><br/>
          <%= text_field("new_establishment_address#{i+1}","address2")%></p>
          <p><%= label :new_address, "city_id" %><br/>
          <%= select("new_establishment_address#{i+1}", "city_id",City.find(:all).collect {|a| [ a.name, a.id ] })%></p>
          <%cpt += 1%>
          <%end%>
          <%end%>
          
          
    <div id="new_etab">
          <div id="link_to_remove">
          <%=link_to_remote("Valider", :url => {:action => "add_form", :cpt => cpt})%>
        </div>
    </div>
</fieldset>


    </fieldset>
      <%= customer.submit  'Modifier' %>
    <%end%>

    <%= link_to 'Retour', :action => 'index' %>