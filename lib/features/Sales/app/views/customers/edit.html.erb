<h4>Modifier un client </h4>

<% form_for(@customer) do |customer| %>
  <%= customer.error_messages %>
  <% #Display customer infos%>
  <fieldset>
    <legend>Informations concernant le client</legend>
  <%= render :partial => 'thirds/third', :locals => {:third => customer} %>
  </fieldset>

  <% if @establishments.length > 0 %>
    <% for establishment in @establishments %>
    <%= error_messages_for("establishment#{establishment.id}") %>
    <%= error_messages_for("establishment#{establishment.id}_address") %>
    <% end #for%>

    <% #Fieldset that content all establishment%>
    <fieldset>
      <% #Faire un plurialize "etablissement de la legend"%>
      <legend> Etablissements du client </legend>
      <% for establishment in @establishments %>
        <% unless establishment.activated == false %>
          <div <%= "id='customer_establishment#{establishment.id}'" %>>

          <%= establishment.name + "(" + establishment.address.city_name + ")"%>
          <%= link_to "Plus d'infos", edit_customer_establishment_path(@customer, establishment, :owner_type => "Customer") %>

        </div>
        <% end #unless %>        
      <% end #for %>
  </fieldset>
  <% end #if%>

  <% if @contacts.length > 0 -%>
  <fieldset>
    <% #Faire un plurialize "Contacts" de la legend"%>
    <legend> Contacts du client</legend> 
      <% for contact in @contacts%>
          <div <%= "id='customer_contact#{contact.id}'" %>>
            <%= contact.first_name + " " + contact.last_name%>
            <%= link_to "Plus d'infos", edit_customer_contact_path(@customer, contact,:owner_type => "Customer") %>
            <%= link_to("Supprimer", [@customer, contact], :method => :delete, :url => {:owner_type => @owner_type}) %>
          </div>
      <%end #for%>   
  </fieldset>
  <%end #if%>

  <% params[:new_establishment_number].nil? ? new_number_form = 0 : new_number_form = @new_establishment_number -%>
  <% # new_establishment_number store establishment number present in establishment_form -%>
  <%= hidden_field("new_establishment_number", "value", "value" => new_number_form) %>

  <% unless params[:new_establishment_number].nil? -%>        
      <% new_establishment_number = params[:new_establishment_number]["value"].to_i -%>
  <% end -%>

  <fieldset>
    <legend> Ajouter un Ã©tablissement pour le client </legend>

    <div id="new_establishment">
      <%unless @error%>
        <div id="link_add_remove_establishment_1">
          <%= link_to_remote("Ajouter", :url => {:action => "add_establishment", :cpt => 1})%>
        </div>
      <%end%>
        <% cpt = 1 %>
        <% unless params[:new_establishment_number].nil? %>
        <% new_establishment_number.times do |i| %>
        <%unless params["valid_establishment_#{i+1}"].nil?%>
            <%unless params["valid_establishment_#{i+1}"]["value"] == "false"%>
              <%= render :partial => 'establishments/new_establishment', :locals => {:cpt=> i+1, :error => true} %>
            <%end #unless%>
        <%end #unless%>
        <% cpt += 1 %>
        <% end %>
        <div id="link_add_remove_establishment_<%=cpt%>">
          <%= link_to_remote("Ajouter", :url => {:action => "add_establishment", :cpt => cpt}) %>
        </div>
      <% end %>          
    </div>
  </fieldset>

  <% params[:new_contact_number].nil? ? new_contact_number = 0 : new_contact_number = @new_contact_number -%>
  <%= hidden_field("new_contact_number", "value", "value" => new_contact_number) %>
  <% unless params[:new_contact_number].nil? -%>        
    <% new_contacts_number = params[:new_contact_number]["value"].to_i -%>
  <% end -%>
  <fieldset>
    <legend> Ajouter un nouveau contact pour le client </legend>

      <div id="new_contact">
          <%unless @error%>
            <div id="link_add_remove_contact_1">
              <%= link_to_remote("Ajouter", :url => {:controller => "contacts",:action => "add_contact", :cpt => 1, 
                  :owner_id => @customer.id, :owner_type => "Customer"}) %>
            </div> 
          <%end%>
          <% cpt = 1 %>
          <% unless params[:new_contact_number].nil? %>
          <% new_contacts_number.times do |i| %>
            <%unless params["valid_contact_#{i+1}"].nil?%>
              <%unless params["valid_contact_#{i+1}"]["value"] == "false"%>
              <div id =<%= "new_contact#{i+1}" %>>
                <%@old_contact = {:first_name => params["new_contact#{i+1}"]["first_name"],
                                          :last_name => params["new_contact#{i+1}"]["last_name"],
                                          :email_name => params["new_contact#{i+1}"]["email"]}%>
                <%= render :partial => 'contacts/new_contact', :locals => {:cpt=> i+1, :error => true, :owner_type => "Customer",
                :owner_id => @customer.id, :old_contact => @old_contact} %>
              
              </div>
              <%end #unless%>
            <%end #unless%>
            <% cpt += 1 %>
          <% end #unless%>
    
          <div id="link_add_remove_contact_<%=cpt%>">
            <%= link_to_remote("Ajouter", :url => {:controller => "contacts",:action => "add_contact", :cpt => cpt, 
                :owner_id => @customer.id, :owner_type => "Customer"}) %>
          </div>
          <% end %>
      </div>
  </fieldset>

  <%= customer.submit  'Modifier' %>
<% end %>

<%= link_to 'Retour', :action => 'index' %>