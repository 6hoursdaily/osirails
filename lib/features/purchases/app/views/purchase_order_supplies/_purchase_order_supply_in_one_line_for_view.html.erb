<% purchase_order_supply_in_one_line_for_view_counter += 1 %>
<% purchase_order_supply = purchase_order_supply_in_one_line_for_view %>
<% purchase_deliveries = purchase_order_supply.purchase_deliveries.compact %>
<% supplier_supply = purchase_order_supply.supplier_supply(purchase_order_supply.purchase_order.supplier.id, purchase_order_supply.supply_id)  %>

<% class_attributes = 'class="even"' if (purchase_order_supply_in_one_line_for_view_counter % 2) == 0 %>
<% class_attributes = 'class="disabled"' if (purchase_order_supply.was_cancelled? || purchase_order_supply.purchase_order.was_cancelled?) %>
<% class_attributes = 'class="even disabled"' if (purchase_order_supply_in_one_line_for_view_counter % 2) == 0 && (purchase_order_supply.was_cancelled? || purchase_order_supply.purchase_order.was_cancelled?) %>
<% purchase_delivery_class_attributes = '' %>

<% unless purchase_order_supply.comment_line?%>
<tr <%= class_attributes %>>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %>><%= display_supply_reference(purchase_order_supply.supply) %></td>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %>><%= purchase_order_supply.supply ?purchase_order_supply.supply.designation : "-" %></td>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %>><%= display_purchase_order_supply_supplier_reference(purchase_order_supply) %></td>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %>><%= display_purchase_order_supply_supplier_designation(purchase_order_supply) %></td>
  
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %>><%= display_type_for(purchase_order_supply.supply) %></td>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %>><%= purchase_order_supply.supply ?purchase_order_supply.supply.stock_quantity : "-" %></td>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %>><%= display_purchase_order_supply_associated_purchase_requests(purchase_order_supply) %></td>
<% if purchase_deliveries.empty? %>
    <td></td>
<% else %>
    <td <%= "class=\"disabled\"" if purchase_deliveries.first && purchase_deliveries.first.was_cancelled? %> ><%= link_to( purchase_deliveries.first.reference, purchase_order_purchase_delivery_path(purchase_order_supply.purchase_order,purchase_deliveries.first)) %></td>
<% end %>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %>><%= display_purchase_order_supply_reshipped_from_purchase_delivery(purchase_order_supply) %></td>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %>><%= display_purchase_order_supply_status(purchase_order_supply) %></td>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %>><%= display_purchase_order_supply_current_status_date(purchase_order_supply) %></td>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %> class="price"><%= display_purchase_order_supply_unit_price_including_tax(purchase_order_supply) %></td>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %>><%= purchase_order_supply.quantity %></td>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %> class="price"><%= display_purchase_order_supply_total(purchase_order_supply) %></td>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %>><%= "#{supplier_supply.lead_time}&#160;jour(s)" if supplier_supply %></td>
  <td <%= "rowspan=\"#{purchase_deliveries.count}\"" unless purchase_deliveries.empty? %>><%= display_purchase_order_supply_buttons(purchase_order_supply) %></td>
</tr>

<% for purchase_delivery in purchase_deliveries %>
  <% if purchase_delivery != purchase_deliveries.first %>
    <% if purchase_delivery.was_cancelled? and (purchase_order_supply_in_one_line_for_view_counter % 2) == 0 %>
      <% purchase_delivery_class_attributes = 'class="even disabled"' %>
    <% elsif !purchase_delivery.was_cancelled? and (purchase_order_supply_in_one_line_for_view_counter % 2) == 0 %>
      <% purchase_delivery_class_attributes = 'class="even"' %>
    <% elsif purchase_delivery.was_cancelled? and (purchase_order_supply_in_one_line_for_view_counter % 2) != 0 %>
      <% purchase_delivery_class_attributes = 'class="disabled"' %>
    <% else %>
      <% purchase_delivery_class_attributes = class_attributes %>
    <% end %>
    <tr <%= purchase_delivery_class_attributes %> >
      <td>
        <%= link_to( purchase_delivery.reference, purchase_order_purchase_delivery_path(purchase_order_supply.purchase_order,purchase_delivery)) %>
      </td>
    </tr>
  <% end %>
<% end %>
<% end %>
